# InnoDB 스토리지 엔진 잠금
InnoDB 엔진은 MySQL에서 지원하는 잠금 레벨보다 조금 더 깊게 들어가서 스토리지 엔진 내부에서 레코드 기반의 잠금 방식을 탑재하고 있다.  
MySQL의 최근 버전에서는 InnoDB의 트랜잭션과 잠금, 그리고 잠금 대기중인 트랜잭션의 목록을 조회할 수 있는 방법이 도입되었다.  
InnoDB의 스토리지 엔진은 레코드 기반 잠금을 제공하고, 이 잠금의 정보는 매우 작은 공간에 할당되어 관리되기 때문에 페이지 락 또는 테이블 락으로 락 레벨이 업되는 경우는 없다.  
일반 상용 DBMS와는 다르게 InnoDB에서는 레코드 락 뿐만 아니라, 레코드와 레코드 사이의 간격을 잠그는 갭(GAP)락도 존재한다.  
그리고 레코드 락과 갭 락을 결합한 넥스트 키 락도 존재한다.

## 레코드 락(Record Lock, Record Only Lock)
레코드 락은 레코드 만을 잠그는 잠금을 의미한다. 일반 상용 DB들과 동일한 역할을 한다.  
하지만 가장 큰 차이점은 InnoDB 스토리지 엔진은 **인덱스를 통한 레코드 락**방식으로 사용된다.  
만약 여기서 인덱스가 없다면? 그래도 InnoDB 엔진은 인덱스를 내부적으로 직접 생성하여 자동 생성된 클러스터 인덱스를 이용해 잠금을 설정한다.  

클러스터 인덱스: 데이터 행 자체가 인덱스 구조에 포함된 인덱스입니다. ex) id - autoincrement

Primary Key 혹은 Unique Index에 의한 변경 작업에서는 갭에 대해서는 잠금을 걸지 않고 레코드 자체에만 락을 건다.

## 갭 락(Gap Lock)
갭 락은 레코드 자체를 잠그는 것이 아니라 레코드와 인접 레코드 사이의 간격을 잠그는 매커니즘이다.  
레코드와 레코드 간격 사이에 새로운 레코드가 생성되는 것을 방지한다. 만약 for update로 조회를 10000 ~ 10005까지 하게되면 그 사이에 데이터 INSERT가 안되도록 락을거는것을 갭 락이라고한다.
갭 락은 그 자체를 설명하기 보다, 넥스트 키 락의 일부로 많이 사용된다.  

## 넥스트 키 락(Next Key Lock)
넥스트 키 락은 레코드 락과 갭 락을 합쳐놓은 형태이다.  
넥스트 키 락은 MySQL의 기본 격리 수준인 `REAPEATABLE READ` 수준에서 발생한다.  
InnoDB 스토리지 엔진은 독특한 특성 덕분에 갭 락이나 넥스트 키 락을 사용하여 REPEATABLE READ 격리 수준에서도 팬텀 리드((Phantom Read))가 발생하지 않도록 방지한다.
